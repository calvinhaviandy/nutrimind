<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard - NutriMind</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300..800&display=swap" rel="stylesheet">

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        display: ["Manrope", "sans-serif"],
      },
      colors: {
        primary: "#135bec",
        muted: "#637588",
        surface: "#ffffff",
        bg: "#f6f6f8",
      },
    },
  },
};
</script>
<style>
.tooltip {
    opacity: 0;
    position: absolute;
    top: -2rem;
    left: 50%;
    transform: translateX(-50%);
    background: black;
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    transition: opacity 0.2s;
}
.group:hover .tooltip {
    opacity: 1;
}
</style>

</head>

<body class="bg-bg font-display text-slate-900">

<div class="flex h-screen overflow-hidden">

    <!-- ================= SIDEBAR ================= -->
    <aside id="sidebar"
        class="fixed md:relative inset-y-0 left-0 w-64 bg-white border-r z-40
                transform -translate-x-full md:translate-x-0 transition duration-300 ease-in-out shadow-lg md:shadow-none">

        <!-- Logo -->
        <div class="h-16 flex items-center px-6 border-b">
            <i data-lucide="leaf" class="text-primary mr-2"></i>
            <span class="font-extrabold text-xl">NutriMind</span>
        </div>

        <!-- Menu -->
        <nav class="p-4 space-y-2">
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary font-semibold transition-all duration-200 hover:translate-x-1 active:scale-95"><i data-lucide="layout-dashboard"></i> Dashboard</a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-muted hover:bg-slate-100 transition-all duration-200 hover:translate-x-1 active:scale-95" href="food-log"><i data-lucide="utensils"></i> Food Log</a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-muted hover:bg-slate-100 transition-all duration-200 hover:translate-x-1 active:scale-95" href="meal-plan"><i data-lucide="calendar"></i> Meal Plans</a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-muted hover:bg-slate-100 transition-all duration-200 hover:translate-x-1 active:scale-95" href="reports"><i data-lucide="bar-chart-3"></i> Reports</a>

            <p class="mt-6 text-xs font-bold uppercase text-muted px-3">Settings</p>

            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-muted hover:bg-slate-100 transition-all duration-200 hover:translate-x-1 active:scale-95"><i data-lucide="user"></i> Profile</a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-muted hover:bg-slate-100 transition-all duration-200 hover:translate-x-1 active:scale-95"><i data-lucide="settings"></i> Preferences</a>
        </nav>

        <div class="absolute bottom-0 w-full border-t p-4">
            <button id="logoutBtn"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200
                    text-muted hover:bg-red-50 hover:text-red-600 active:scale-95">
                <i data-lucide="log-out" class="w-5"></i>
                <span class="font-medium">Logout</span>
            </button>
        </div>

    </aside>

    <!-- ================= MAIN ================= -->
    <div class="flex-1 flex flex-col">

        <!-- Mobile Header -->
        <header class="md:hidden h-16 bg-white border-b flex items-center justify-between px-4">
            <div class="flex items-center gap-2 font-bold">
                <i data-lucide="leaf" class="text-primary"></i> NutriMind
            </div>
            <button onclick="toggleSidebar()" class="transition-transform duration-150 active:scale-90">
                <i data-lucide="menu"></i>
            </button>
        </header>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8">

            <!-- Header -->
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                <div>
                    <h1 id="greetingText" class="text-3xl font-extrabold"></h1>
                    <p class="text-muted mt-1">Hereâ€™s your daily nutrition breakdown</p>
                </div>
                <div class="bg-white px-4 py-2 rounded-lg border flex items-center gap-2">
                    <i data-lucide="calendar" class="w-4 text-muted"></i>
                    <span id="dateText" class="text-sm font-medium"></span>
                </div>
            </div>

            <!-- Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

                <!-- LEFT -->
                <div class="lg:col-span-8 xl:col-span-9 flex flex-col gap-6">

                    <!-- STATS -->
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">

                        <!-- CALORIES -->
                        <div class="md:col-span-5 bg-white rounded-xl p-6 border flex flex-col items-center relative transition duration-200 hover:-translate-y-1 hover:shadow-lg">
                            <p class="absolute top-4 left-4 text-xs font-bold uppercase text-muted">Calories</p>

                            <div class="relative w-40 h-40 mt-6">
                                <svg viewBox="0 0 36 36" class="-rotate-90">
                                <path id="calorieProgress"
                                    d="M18 2.0845 a 15.9 15.9 0 0 1 0 31.83"
                                    fill="none"
                                    stroke="#135bec"
                                    stroke-width="3"
                                    stroke-dasharray="0,100"/>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="remainingCalories" class="text-3xl font-extrabold">1,250</span>
                                <span class="text-xs uppercase text-muted">Remaining</span>
                                </div>
                            </div>

                            <div class="flex justify-between w-full mt-6">
                                <div class="text-center">
                                <p class="text-xs text-muted">Consumed</p>
                                <p class="font-bold" id="consumedCalories">950</p>
                                </div>
                                <div class="text-center">
                                <p class="text-xs text-muted">Goal</p>
                                <p class="font-bold" id="goalCalories">2,200</p>
                                </div>
                            </div>
                        </div>

                        <!-- MACROS + ACTIONS -->
                        <div class="md:col-span-7 flex flex-col gap-6">

                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="bg-white p-4 rounded-xl border transition duration-200 hover:-translate-y-1 hover:shadow-md">
                                    <p class="text-sm text-muted">Protein</p>
                                    <p class="text-xl font-bold">
                                        <span id="proteinValue">0</span>g
                                        <span class="text-xs text-muted">/140g</span>
                                    </p>
                                    <div class="h-1.5 bg-slate-100 rounded mt-2">
                                        <div class="h-full bg-primary rounded" id="proteinBar"></div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border transition duration-200 hover:-translate-y-1 hover:shadow-md">
                                    <p class="text-sm text-muted">Carbs</p>
                                    <p class="text-xl font-bold">
                                        <span id="carbsValue">0</span>g
                                        <span class="text-xs text-muted">/250g</span>
                                    </p>
                                    <div class="h-1.5 bg-slate-100 rounded mt-2">
                                        <div class="h-full bg-yellow-400 rounded" id="carbsBar"></div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border transition duration-200 hover:-translate-y-1 hover:shadow-md">
                                    <p class="text-sm text-muted">Fat</p>
                                    <p class="text-xl font-bold">
                                        <span id="fatValue">0</span>g
                                        <span class="text-xs text-muted">/70g</span>
                                    </p>
                                    <div class="h-1.5 bg-slate-100 rounded mt-2">
                                        <div class="h-full bg-red-400 rounded" id="fatBar"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- QUICK ACTIONS -->
                            <div class="grid grid-cols-2 gap-4 h-full">
                                <a href="scanfood"
                                    class="bg-primary/5 border-2 border-primary/20 rounded-xl p-4
                                            flex flex-col items-center justify-center gap-3
                                            hover:bg-primary/10 text-center transition duration-200 hover:-translate-y-1 hover:shadow-md active:scale-95">
                                    <i data-lucide="camera" class="w-7 text-primary"></i>
                                    <span class="font-bold">Scan Food</span>
                                </a>

                                <!-- Generate Plan -->
                                <a href="generate-plan"
                                    class="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-4
                                            flex flex-col items-center justify-center gap-3
                                            hover:bg-indigo-100 text-center transition duration-200 hover:-translate-y-1 hover:shadow-md active:scale-95">
                                    <i data-lucide="sparkles" class="w-7 text-indigo-600"></i>
                                    <span class="font-bold">Generate Plan</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- TODAY'S LOG -->
                    <div class="bg-white rounded-xl border flex flex-col h-full transition duration-200 hover:-translate-y-1 hover:shadow-lg">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h3 class="text-lg font-bold">Today Meals Log</h3>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-center">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3 text-xs font-semibold uppercase text-muted">Meal</th>
                                        <th class="px-6 py-3 text-xs font-semibold uppercase text-muted">Food Item</th>
                                        <th class="px-6 py-3 text-xs font-semibold uppercase text-muted">Calories</th>
                                        <th class="px-6 py-3 text-xs font-semibold uppercase text-muted">Time</th>
                                    </tr>
                                </thead>

                                <tbody class="divide-y">
                                    <tr>
                                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-700">Breakfast</span></td>
                                        <td class="px-6 py-4 font-medium">Oatmeal & Berries</td>
                                        <td class="px-6 py-4">350 kCal</td>
                                        <td class="px-6 py-4 text-center text-muted">8:30 AM</td>
                                    </tr>

                                    <tr>
                                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Lunch</span></td>
                                        <td class="px-6 py-4 font-medium">Grilled Chicken Salad</td>
                                        <td class="px-6 py-4">450 kCal</td>
                                        <td class="px-6 py-4 text-center text-muted">1:15 PM</td>
                                    </tr>

                                    <tr>
                                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-700">Snack</span></td>
                                        <td class="px-6 py-4 font-medium">Almonds & Apple</td>
                                        <td class="px-6 py-4">150 kCal</td>
                                        <td class="px-6 py-4 text-center text-muted">4:00 PM</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- RIGHT -->
                <div class="lg:col-span-4 xl:col-span-3 space-y-6">

                    <!-- Hydration -->
                    <div class="bg-white p-6 rounded-xl border transition duration-200 hover:-translate-y-1 hover:shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">Hydration</h3>
                            <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                                <i data-lucide="droplet" class="text-blue-500 w-4"></i>
                            </div>
                        </div>

                        <p id="hydrationText"
                            class="text-center text-3xl font-extrabold text-primary mb-4">
                        </p>

                        <!-- Glass Grid -->
                        <div id="hydrationGrid" class="grid grid-cols-4 gap-2 mb-4"></div>

                        <button id="addWaterBtn" class="w-full border rounded-lg py-2 text-primary font-semibold hover:bg-primary/5 transition-transform duration-150 active:scale-95">
                            + Add Water
                        </button>
                    </div>

                    <div class="bg-white rounded-xl p-6 border border-[#e5e7eb] shadow-sm transition duration-200 hover:-translate-y-1 hover:shadow-lg">
                        <h3 class="text-sm font-bold text-[#637588] uppercase tracking-wider mb-4">
                            Weekly Progress
                        </h3>

                        <div class="h-32 flex items-end justify-between gap-2">

                            <!-- Monday -->
                            <div class="week-bar w-full bg-[#f0f2f4] rounded-t-sm h-[60%] 
                                        hover:bg-blue-200 transition-colors cursor-pointer 
                                        relative group"
                                data-index="0"
                                data-label="M">
                                <div class="tooltip">M</div>
                            </div>

                            <!-- Tuesday -->
                            <div class="week-bar w-full bg-[#f0f2f4] rounded-t-sm h-[80%] 
                                        hover:bg-blue-200 transition-colors cursor-pointer 
                                        relative group"
                                data-index="1"
                                data-label="T">
                                <div class="tooltip">T</div>
                            </div>

                            <!-- Wednesday (active) -->
                            <div class="week-bar w-full bg-primary rounded-t-sm h-[45%] 
                                        cursor-pointer relative group"
                                data-index="2"
                                data-label="W">
                                <div class="tooltip">W</div>
                            </div>

                            <!-- Thursday -->
                            <div class="week-bar w-full bg-[#f0f2f4] rounded-t-sm h-[70%] 
                                        hover:bg-blue-200 transition-colors cursor-pointer 
                                        relative group"
                                data-index="3"
                                data-label="T">
                                <div class="tooltip">T</div>
                            </div>

                            <!-- Friday -->
                            <div class="week-bar w-full bg-[#f0f2f4] rounded-t-sm h-[90%] 
                                        hover:bg-blue-200 transition-colors cursor-pointer 
                                        relative group"
                                data-index="4"
                                data-label="F">
                                <div class="tooltip">F</div>
                            </div>

                            <!-- Saturday -->
                            <div class="week-bar w-full bg-[#f0f2f4] rounded-t-sm h-[50%] 
                                        hover:bg-blue-200 transition-colors cursor-pointer 
                                        relative group"
                                data-index="5"
                                data-label="S">
                                <div class="tooltip">S</div>
                            </div>

                            <!-- Sunday -->
                            <div class="week-bar w-full bg-[#f0f2f4] rounded-t-sm h-[65%] 
                                        hover:bg-blue-200 transition-colors cursor-pointer 
                                        relative group"
                                data-index="6"
                                data-label="S">
                                <div class="tooltip">S</div>
                            </div>

                        </div>
                    </div>


                    <!-- Tip -->
                    <div class="bg-gradient-to-br from-primary to-blue-800 text-white p-6 rounded-xl transition duration-200 hover:-translate-y-1 hover:shadow-xl">
                        <div class="flex items-center gap-2 text-sm uppercase mb-2 opacity-90">
                            <i data-lucide="lightbulb"></i> Daily Tip
                        </div>
                        <p class="font-medium">
                            -
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("-translate-x-full");
    }

    function getLocalISODate(d = new Date()) {
        const tzOffset = d.getTimezoneOffset() * 60000;
        return new Date(d - tzOffset).toISOString().slice(0,10);
    }

    const today = getLocalISODate();

    fetch(`/api/dashboard?date=${today}`)
    .then(res => res.json())
    .then(data => {

    /* ================= GREETING ================= */
    const hour = new Date().getHours();
    let greeting = "Good Evening";

    if (hour < 12) greeting = "Good Morning";
    else if (hour < 18) greeting = "Good Afternoon";

    document.getElementById("greetingText").innerText =
        `${greeting}, ${data.user}`;

    const dateOptions = { month: "short", day: "numeric", year: "numeric" };
    document.getElementById("dateText").innerText =
        new Date().toLocaleDateString("en-US", dateOptions);

    /* ================= CALORIES ================= */
    const goal = 2200;
    const consumed = Math.round(data.intake.calories || 0);
    const remaining = Math.max(0, goal - consumed);

    document.getElementById("consumedCalories").innerText = consumed;
    document.getElementById("goalCalories").innerText = goal;
    document.getElementById("remainingCalories").innerText = remaining;

    const percent = Math.min(100, (consumed / goal) * 100);
    document.getElementById("calorieProgress")
        .setAttribute("stroke-dasharray", `${percent},100`);

    /* Warna progress */
    const stroke =
        percent < 80 ? "#135bec" :
        percent < 100 ? "#f59e0b" : "#ef4444";

    document.getElementById("calorieProgress").setAttribute("stroke", stroke);

    /* ================= MACROS ================= */
    const macros = {
        protein: { value: data.intake.protein, goal: 140, bar: "proteinBar", text: "proteinValue" },
        carbs:   { value: data.intake.carbs, goal: 250, bar: "carbsBar", text: "carbsValue" },
        fat:     { value: data.intake.fat, goal: 70,  bar: "fatBar", text: "fatValue" }
    };

    Object.values(macros).forEach(m => {
        document.getElementById(m.text).innerText = Math.round(m.value || 0);
        const pct = Math.min(100, (m.value / m.goal) * 100);
        document.getElementById(m.bar).style.width = pct + "%";
    });

    /* ================= HYDRATION ================= */
    const hydrationCount = data.hydration || 0;

    // Text "4 / 8 Glasses"
    document.getElementById("hydrationText").innerHTML =
        `${hydrationCount} <span class="text-sm font-medium text-muted">/ 8 Glasses</span>`;

    // Render glass grid
    const grid = document.getElementById("hydrationGrid");
    grid.innerHTML = "";

    for (let i = 1; i <= 8; i++) {
        const glass = document.createElement("div");
        glass.className = `
            h-10 rounded-lg
            ${i <= hydrationCount ? "bg-primary" : "bg-blue-100"}
        `;
        grid.appendChild(glass);
    }

    // Today Meals Log
    const tbody = document.querySelector("tbody.divide-y");
    tbody.innerHTML = "";

    const mealColors = {
        "Breakfast": "bg-orange-100 text-orange-700",
        "Lunch": "bg-green-100 text-green-700",
        "Dinner": "bg-blue-100 text-blue-700",
        "Snack": "bg-purple-100 text-purple-700"
    };

    data.meals.forEach(m => {
        const colorClass = mealColors[m.meal_type] || "bg-gray-100 text-gray-700";

        tbody.innerHTML += `
            <tr>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded-full ${colorClass}">
                        ${m.meal_type}
                    </span>
                </td>
                <td class="px-6 py-4 font-medium">${m.title}</td>
                <td class="px-6 py-4">${m.calories} kCal</td>
                <td class="px-6 py-4 text-muted">${m.time}</td>
            </tr>
        `;
    });

    /* ================= WEEKLY ================= */
    const bars = document.querySelectorAll(".week-bar");
    data.weekly.forEach((d,i)=>{
        const pct = Math.min(100, d.value / goal * 100);
        bars[i].style.height = pct + "%";

        if (d.is_today) {
        bars[i].classList.remove("bg-[#f0f2f4]");
        bars[i].classList.add("bg-primary");
        }
    });
    });

    // Add Water
    document.getElementById("addWaterBtn").addEventListener("click", () => {
    fetch("/api/add-water", { method: "POST" })
        .then(res => res.json())
        .then(() => location.reload());
    });

    // Daily Tip
    fetch("/api/daily-tip")
    .then(r=>r.json())
    .then(d=>{
    document.querySelector(".bg-gradient-to-br p").innerText = d.tip
    })

    // logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout";
    }
    });

    lucide.createIcons();
</script>

</body>
</html>
